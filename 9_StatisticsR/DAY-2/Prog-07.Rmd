---
title: "Exploratory data analysis"
author: "Montserrat Guillen"
date: "2017"
output:
  pdf_document:
    toc: yes
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
---

******
# Introduction
******

This is a very short introduction to the exploration of data using RStudio and Rmarkdown. 

This document sequentially applies a set of Data Science techniques to gain insights from the Direct Marketing campaign of a Portuguese Banking Institution. 

First we need to read the data from the file "bank-additional-full.csv"
```{r,eval=TRUE,echo=TRUE}
#setwd("..")
bank<-read.table(file="bank-additional-full.csv",header=T,sep=";")
```

The dataset contains information on ```r nrow(bank)``` clients and ```r ncol(bank)```variables.

 *Input variables:
 
   *# bank client data:
   
   1 - age (numeric)
   
   2 - job : type of job (categorical: "admin.","unknown","unemployed", 
                                           "management","housemaid","entrepreneur","student",
                                       "blue-collar","self-employed","retired","technician","services") 
   
   3 - marital : marital status (categorical: "married","divorced","single"; note: "divorced"
                                              means divorced or widowed)
   
   4 - education (categorical: "unknown","secondary","primary","tertiary")
   
   5 - default: has credit in default? (binary: "yes","no")
   
   6 - housing: has housing loan? (binary: "yes","no")
   
   7 - loan: has personal loan? (binary: "yes","no")
   
   
   *# related with the last contact of the current campaign:
   
   8 - contact: contact communication type (categorical: "unknown", "telephone","cellular")

   9 - month: last contact month of year (categorical: "jan", "feb", "mar", ..., "nov", "dec")
  
  10 - day_of_week: last contact day of the month (numeric)
  
  11 - duration: last contact duration, in seconds (numeric)
   
   # other attributes:
  
  12 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
  
  13 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric, -1 means client was not previously contacted)
  
  14 - previous: number of contacts performed before this campaign and for this client (numeric)
  
  15 - poutcome: outcome of the previous marketing campaign (categorical: "unknown","other","failure","success")
  
 *# social and economic context attributes
 
16 - emp.var.rate: employment variation rate - quarterly indicator (numeric)

17 - cons.price.idx: consumer price index - monthly indicator (numeric) 

18 - cons.conf.idx: consumer confidence index - monthly indicator (numeric) 

19 - euribor3m: euribor 3 month rate - daily indicator (numeric)

20 - nr.employed: number of employees - quarterly indicator (numeric)

  *Output variable (desired target):

  21 - **y** - **has the client subscribed a term deposit?** (binary: "yes"=1,"no"=0)
  
## Names of the variables

We print de names of the variables

```{r,eval=TRUE,echo=TRUE}
colnames(bank)
```

We will use function **attach** so that we can call variable just by their name instead of bank$name

```{r,eval=TRUE,echo=TRUE}
attach(bank)
```

## An overview of the Data Analysis

image: ![](Chart.png)

  
## Required packages
The function, "install.packages()", downloads and installs R programming language packages from CRAN-like repositories or from local files.

```{r,eval=TRUE,echo=TRUE}

# Required Packages
# install.packages("ggplot2") # plotting
# install.packages("knitr") # report formatting
# install.packages("cluster") # kmeans clustering
# install.packages("HSAUR") # silhouette plotting
# install.packages("fpc") # numbers cluster plot
# install.packages("lattice") # cluster plotting
# install.packages("rpart") # Decision Tress data classification
# install.packages("kernlab") # Support Vector Machines machine learning
# install.packages("randomForest") # Random Forest machine learning

library(ggplot2)
library(dplyr)
#library(knitr)
#library(cluster)
#library(HSAUR)
#library(fpc)
#library(lattice)
#library(rpart)
#library(kernlab)
#library(randomForest)
```


## Session information 

This is information on the R version used in this example

```{r,eval=TRUE,echo=TRUE}
sessionInfo()
```


## Sample of records

```{r,eval=TRUE,echo=TRUE}
head(bank)
```

# Data visualization

## Data Summary of the Bank Additional Dataset
```{r,eval=TRUE,echo=TRUE}
summary(bank)
```

## Specific statistical measures

```{r,eval=TRUE,echo=TRUE}
sapply(bank[c("age", "duration")], median, 1)
```

## Plots: Pie chart

```{r,eval=TRUE,echo=TRUE}
table(y)
prop.table(table(y)) 
round(prop.table(table(y))*100, 2)

ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")

```

We now use another palette and labeling. 

```{r,eval=TRUE,echo=TRUE}
ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")+ scale_fill_brewer("Blues")

blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")+ scale_fill_brewer("Term Diposit")+ blank_theme +
  theme(axis.text.x=element_blank())+
  theme(axis.text.y=element_blank())
  
```

# Grouping bars: Frequency

```{r,eval=TRUE,echo=TRUE}
t=data.frame(table(y, marital))
ggplot(t, aes(x=marital, y=Freq, fill=y)) +
  geom_bar(position='dodge', stat='identity')
```

# Grouping bars: Percent

You can try a number of different palettes "Greens", "Set1", "Set2", etc...

```{r,eval=TRUE,echo=TRUE}
t=data.frame(prop.table(table(y ,marital), 2))
ggplot(t, aes(x=marital, y=Freq*100, fill=y)) +
  geom_bar(position='dodge', stat='identity')+
  ylab("Percent (%)")+ scale_fill_brewer("Term Diposit", palette="Spectral")
```

## Histograms of age and duration


```{r,eval=TRUE,echo=TRUE}
ggplot(data=bank, aes(age)) + geom_histogram(bins=35)

ggplot(data=bank, aes(duration)) + geom_histogram(bins=40)
```
 
```{r,eval=TRUE,echo=TRUE}
ggplot(data=bank, aes(age)) + geom_density(alpha=1)

ggplot(data=bank, aes(duration)) + geom_density()
```
 
 
  ## Plot of both

Palettes: 

Diverging
BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn, Spectral

Qualitative
Accent, Dark2, Paired, Pastel1, Pastel2, Set1, Set2, Set3

Sequential
Blues, BuGn, BuPu, GnBu, Greens, Greys, Oranges, OrRd, PuBu, PuBuGn, PuRd, Purples, RdPu, Reds, YlGn, YlGnBu, YlOrBr, YlOrRd

```{r,eval=TRUE,echo=TRUE}
  t2=subset(bank, pdays<999)
 ggplot(t2) +
  geom_tile(aes(age, pdays,fill = duration))+
   scale_fill_distiller(palette = "Spectral")
 
```


We have a problem with the variable **pdays**, because when the customer was not contacted, the value is 999.

```{r,eval=TRUE,echo=TRUE}
ggplot(data=bank, aes(pdays))+ geom_density()+scale_fill_brewer()

ggplot(data=t2, aes(pdays))+ geom_density()+scale_fill_brewer()

plot(y, age)

plot(t2$y, t2$pdays)

```


# Evolution over time

```{r,eval=TRUE,echo=TRUE}
t3=data.frame(prop.table(table(y, month),2))
t3$month_order=factor(as.character(t3$month), levels = c("mar", "apr", "may", "jun","jul", "aug", "sep", "oct", "nov", "dec"))

t4 = group_by(bank, month) %>% summarise(Euribor=mean(euribor3m)) %>% ungroup()
t4$month_order=factor(as.character(t4$month), levels = c("mar", "apr", "may", "jun","jul", "aug", "sep", "oct", "nov", "dec"))

ggplot(t3, aes(x=month_order, y=Freq)) + 
  theme(plot.background = element_blank(),
              # panel.grid.minor = element_blank(),
              #  panel.grid.major = element_blank(),
                panel.border = element_blank(),
                panel.background = element_blank(),
                axis.ticks = element_blank(), # axis.title = element_blank()
        )+
    geom_linerange(t3, mapping=aes(x=month_order, ymin=0, ymax=Freq), colour = "wheat2", alpha=1, size=5) +
   geom_line(t4, mapping=aes(x=month_order, y=Euribor/5, group=1, colour= "Monthly average ")) +
scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Euribor 3m")) +
scale_colour_manual(values = c("red")) +
 labs(y = "Term diposit [%]",
                x = " Month ",
                colour = "Euribor 3m") +
 theme(legend.position = c(0.8, 0.9))





``` 
    

# Reference

More information on graphics with R (ggplot2)

http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html
